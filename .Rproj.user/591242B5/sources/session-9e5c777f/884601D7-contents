---
title: "Who participates in European politics"
format: 
  html:
    number-sections: true
    toc: true
    code-folding: hide
    author: Hieko Giebler, Johannes Giesseke, Macartan Humphreys, Swen Hutter, Heike Klüver
bibliography: bib.bib
---


```{r echo=FALSE, message=FALSE, warning=FALSE}

library(knitr)
library(kableExtra)
library(DeclareDesign)
library(tidyverse)
library(lme4)
library(lmerTest)
library(multilevelTools) 
library(rstanarm)
options(mc.cores = parallel::detectCores())
library(rstan)
rstan_options(auto_write = FALSE)
run <- FALSE
```

Although voting is perhaps the most important form of political participation, European citizens have a differentiated repertoire of ways to make their voices heard in politics. There is, however, considerable, if poorly understood, variation within and across European states in nonelectoral political engagement across different issue areas. This becomes even more important as turnout is declining in many democracies and as there seems to be less trust in political parties and democratic institutions in various countries (for example, @petrarca_2022). At the same time, other, alternative modes of participation like demonstrations or civil disobedience are being used more frequently again @ortiz_world_2022 and not the least due to new media, it has become easier for citizens to get in touch directly with politicians @theocharis_continuous_2018. 

We examine the mobilization potential for political participation with respect to two  salient and polarizing policy issues, namely immigration and climate change, in a comparative perspective. Using data from an original module fielded as part of the 2024 European Parliament Election Study, we are interested in how opposing positions and policy proposals regarding these two contentious issues mobilize or countermobilize citizens depending on individual and contextual factors. To what extent and how do proposals for or against restrictive immigration policies and ambitious climate change policies affect citizens' intentions to participate in politics? Is it easier to mobilize citizens for or against a particular proposal? And to what extent do immigration and climate change differ, given that the former has been heavily politicized by the right and the latter by the left?

Our research builds bridges between research on political participation (for a recent overview, see @giugni2022oxford) and research on polarization and cleavage formation in European societies (e.g. @borbath2023cleavage; @hooghe2018cleavage; @hutter2014protesting; @kriesi2012political). To do so, one needs to go beyond the standard measures of political participation in survey research, which since the classic study by @barnes1979political, do not take into account the issues and demands that mobilize people, but rather ask generic questions about whether they have generally participated or intend to participate in a certain form of action (e.g., the standard batteries of the European Social Survey or the World Value Survey). 

In this project we we take up the concept of ‘issue-specific mobilization potential’, defined as ‘an individual’s propensity to engage in certain political activities in order to defend his or her position with regard to a specific issue’ (@giugni2022oxford: 155). By making use of randomized assignments to the four specific policy proposals, we get a richer understanding of the potentials to mobilize citizens in favor or against certain key policy reforms, taking into account the different participation patterns and levels of politicization of the two issues across EU member states (for a related proposal to get at issue-specific and differentiated patterns of non-institutional participation, see @borbath2024differentiation).

In addition to pushing the boundaries of existing research by applying the concept of issue-specific mobilization potential to a large-scale comparative setting, we also make use of different measures of participation as outcome measures. Our primary outcome measure is behavioral, asking the respondents whether they would like to be added to an (anonymous) petition on the randomly assigned policy proposal, whose aggregate results will be presented to members of the European parliament. Furthermore we  focus on two central forms of institutionalized and non-institutionalized political participation – people's reported likelihood to contact a politician and to take part in a public demonstration. This allows us to gain insights not only concerning different kinds of political participation (signing petitions, contacting politicians and attending demonstrations), but also to base our findings on actual (petition) as well as indented (contacting politicians and attending demonstrations) behavior. In doing so, our research is directly relatable to existing research on mobilization and participation while going one step further. 

We describe analyses for two papers.

* Paper 1 documents variation in political engagement in two issues areas (climate change and migration) and for opposing sides on the two issues (left and right) across the European Union, and it identifies country-level correlates of engagement.
* Paper 2 seeks to explain individual-level engagement across the EU on either side of these two issue areas, as a function of individual internal and external efficacy.

The rest of this document motivates these two papers, describes the core analyses to be performed, and gives survey details. 

The topics we examine are described in @sec-treatments and the core outcome measure is described in  @sec-behavioral.

# Variation in political engagement across the EU

## Motivation

Paper 1 focuses on  political engagement across the EU and has three central goals:

Our first goal is to document the variation across the EU in citizens' willingness to participate on prominent issues, identifying which countries produce the greatest and weakest engagement overall.

Second, insofar as we see variation we seek to understand the extent to which this arises from differences in views across Europe---or different propensities of citizens to act, conditional on their political opinions.

Of particular interest is how the level of participation and the cross-national variation in participation varies across left and right sides of the two topical issues. 'Left' and 'right' here refers to positions more in line with the liberal/GAL (favorable position towards immigration and climate protection) or with the authoritarian/TAN (oposition to immigration and climate protection) pole of political competition @hooghe2018cleavage; @hutter2014protesting; @kriesi2012political. As indicated before, we are interested in whether it is  easier to mobilize citizens for or against a particular proposal, and to what extent immigration and climate change differ, given that the former has been heavily politicized by the right and the latter by the left. To examine these questions, we separately estimate for each of the four petitions the extent to which countries vary in participation as a function of positions on issues or as a function of responsiveness to positions on issues.

Third we will examine a small set of predictors of engagement on European issues including a measure of broader national participation, thematic salience and polarization measures, and measures of national government orientation.

Our primary analysis focuses on the behavioral measure with additional analyses focusing on our two measures of reported ed willingness to engage.


## Analysis

The primary analysis of variation estimates the following hierarchical model:

$Y_{ij} = a_j + e_{i,j}, a_j \sim N(\mu_a, \sigma_a)$

where $Y_{ij}$ is the decision to petition/participate by individual $i$ in country $j$, for any of the petitions (see [petition item](#behavioral)).

Here $(a_j)$ captures the overall engagement level in country $j$, $\mu_a$ captures the expected level for a European state, and $\sigma_a$ captures cross country heterogeneity.


The secondary analysis examines variation across the four petitions, disaggregating differences that are due to differences in attitudes ($X$) and difference in action given attitudes.


For each petition:

$Y_{ij} = a_j + b_j X_{i} + e_{i,j}, a_j \sim N(\mu_a, \sigma_a),  b\sim N(\mu_b, \sigma_b)$

National-level variation due to attitudes for country $j$ is then given by:

$\delta^X :=  b_j(\overline{X}_j-\overline{X})$ where $\overline{X}_j$ is the average attitude on an issue in country $j$ and $\overline{X}$ is the European average.

Variation due to responsiveness in country $j$ is then given by:

$\delta^b :=  a_j - \mu_a + (b_j-\mu_b)\overline{X})$ 

This is a decomposition in that:

$\overline{Y}_{j} - \overline{Y} = (a_j + b_j \overline X_{j}) - (\mu_a + \mu_b \overline{X})=(a_j-\mu_a + (b_j- \mu_b)\overline{X}) + b_j (\overline X_{j}- \overline{X}) = \delta^X + \delta^b$

The decomposition is then compared across the four petition versions.

Tertiary analysis then explores country-level factors that help explain variation in $a_j$, for individuals supportive of the position. That is, conditioning on answers to questions [CLIVAL](#CLIVAL) and [MIGVAL](#MIGVAL) being above (below) 5 for corresponding petitions, we estimate:


$Y_{ij} = a_j + e_{i,j}, a_j \sim N(\mu_a, \sigma_a), \mu_j = X\beta$

for country covariates $X$--taken one at a time---including:

* national-level measures of protest incidence
* national measures of the salience and polarization of the two issues, and their combined effect in a politicization index (salience x polarization)
* immigration exposure (% population with migrant background / number of asylum applications std. by population size)
* exposure to climate change (temperature deviation since 2000 from long run averages)
* left / right leaning governments


# Explaining individual engagement

## Motivation

Paper 2 seeks to understand how individual level political efficacy translates into action and the extent to which variation across countries can be explained by different dimensions of political efficacy (on the role of political efficacy on intended political participation, see @hart2016influence).

A simple model of political participation suggests that citizens will act when:

* (alignment) The action aligns with their preferences, where alignment depends both on position and the belief that one's views on political issues are meaningful ("internal efficacy")
*and*
* (instrumental) They believe actions could make a difference: in particular if  politicians will act if informed ("external efficacy")  *and* that politicians are uninformed ("opportunity"). 

or when

* (intrinsic) they believe it intrinsically important to participate. 

Our [behavioral items](#behavioral) are designed to capture these considerations, 

Our primary motivation is to understand the roles of these three features and their interactions. Our secondary goal is to assess variation in the importance of these across countries and the extent to which variation in these features can explain variation in engagement between individuals and across countries.

## Analysis

The primary analysis uses a least squares specification and includes fixed effects for each country to relate [behavioral items](#behavioral) and [items](#efficacy) capturing alignment, instrumental motivations. and intrinsic motivations. Specifically  13.7 (intrinsic), together with position, is used to capture alignment (position * (1-intrinsic)), 13.6 (external) and 13.10 (opportunity) are multiplicatively combined to capture instrumental motivations (external * (1-opportunity)), and 13.9 is used to capture intrinsic motivations.   We include  a full set of interactions between the three sets of measures, with dummies ($a_k$, $k \in\{1,2,3,4\}$) for the  four petition versions, and conditioning on respondents that are supportive of the petition position.

Secondary analysis uses a hierarchical model with the three measures entering independently:

$$Y_i = a_k+b_{j,0} + b_{j,1}alignment + b_{j,2}external+b_{j,3}intrinsic, b_{j,i} \sim N(\mu_i, \sigma_i), i \in\{0, 1,2,3\}$$

We again report the extent to which country-level variation in engagement among those supportive is due to variation in the efficacy items or variation in the responsiveness of actions to these items.

Tertiary analysis includes and reports predictors listed in section [controls](#controls) and seeks to assess the extent to which differences between groups can be explained on the basis of differential values for alignment, external efficacy, and intrinsic motivations.

Our primary analysis focuses on the behavioral measure with additional analyses focusing on our two measures of reported willingness to engage.

# Survey information

The study uses public opinion data from all 27 members states of the EU within the framework of the 2024 European Election Study.  In particular we draw on a  questionnaire module that focuses on mobilization potential and actual political participation concerning salient policy issues, namely migration and climate change, in a comparative perspective. We

The survey population will be resident in each of the Member States of the EU and aged 18 years of age and over for most countries, but 16 for Belgium, Germany, Malta, and Austria, and 17 for Greece in any the respective nationalities of the 27 European Union Member States. It will cover the national population of citizens as well as the population of citizens of all the European Union Member States that are residents in these countries and have a sufficient command of the national languages to answer the questionnaire.

Respondents in this survey will be drawn from an existing online access panel curated by Demoscopy. The company was established by a group of experienced pollsters and market research professionals who have been part of leading market and digital research organizations for over 25 years. 

Recruitment into these panels uses multiple methods (via advertisements, after participating in face-to-face or telephone surveys, etc.). Selection is based on a mix of randomization and quota-fulfillment.  The quota component aims for a sample to  be broadly representative of each country’s distribution of (inter alia) gender, age, region, and level of urbanization. 

The minimum sample size for each country is 1,000 respondents (completed questionnaires) in each country. For the smaller EU countries, specifically Malta, Cyprus, and Luxembourg, the target is a minimum of 500 respondents. Quota-sampling will be applied.


# Measures

## Issues (Treatments) {#sec-treatments}

In each country, respondents are assigned randomly to one of four groups covering two issues 

The two issues are:


```{r echo=FALSE, message=FALSE, warning=FALSE}

# Create a data frame with the topic and group treatment data
topic_data <- data.frame(
  Topic = c("Immigration", "Climate change"),
  Group = c("1 & 2", "3 & 4"),
  Treatment = c("[…migration to…]", "[…climate change in…]")
)

# Create the table using kable and kableExtra
kable(topic_data, col.names = c("Topic", "Group", "Treatment")) %>%
  kable_styling(full_width = TRUE, position = "center") %>%
  column_spec(3, width = "20em") # Adjust the width of the third column
```


The four conditions are:

```{r echo=FALSE, message=FALSE, warning=FALSE}

# Create a data frame with the topic and group treatment data
treatment_data <- data.frame(
  Topic = c("Immigration", "Immigration", "Climate change", "Climate change"),
  Group = c(1, 2, 3, 4),
  Treatment = c("[…secure stricter controls at its external borders to strongly limit immigration]",
                "[…create safe and humanitarian routes into the EU allowing for more immigration]",
                "[…implement stronger measures to fight climate change even if this means rising energy costs for everyone]",
                "[…prioritise low energy costs for everyone even if this means that climate change goals cannot be achieved]")
)

# Create the table using kable and kableExtra
kable(treatment_data, col.names = c("Topic", "Group", "Treatment")) %>%
  kable_styling(full_width = TRUE, position = "center") %>%
  column_spec(3, width = "40em") # Adjust the width of the third column
```

In subsequent questions respondents are asked about their likely engagement on these issues.


## Outcome (primary): Invitation to share opinion with the European Parliament {#sec-behavioral}

### Introductory text

<div style="text-align: center; font-weight: bold; margin-top: 20px; margin-bottom: 20px;">
    Invitation to make your voice heard 
</div>

_____

*A multinational team of researchers is gathering citizens’ opinions on a small set of policy issues and will share the aggregated results with members of the European Parliament. The goal is to help make sure that citizens’ opinions are better known to politicians – regardless of whether citizens support one side of a policy proposal or the other.*

*Participants in this survey are given the chance to support different positions on different issues, by means of supporting a petition. For practical reasons we can only show one petition to each survey participant. Other participants will see petitions that represent different sides on different issues. The petition that you see is chosen randomly by a computer programme to ensure the political neutrality of the survey.*

*You are being given the chance to add (or not add) your voice to the following petition:*

*The EU needs to **[TREATMENT: Policy proposal]**.*

*To access the petition type “EU2024” in the box below. You can also choose to skip this petition by leaving the box empty.* 

*ENTER CODE “EU2024” TO ACCESS THE PETITION or leave blank if you want to end the survey directly: _________________*

[Continue]

_____

**Note:** The code is constant for all respondents, the assignment to one of the treatments is the same as above. If respondents do enter anything but EU2024, they should receive an error message (like putting in letters when asked for their year of birth). We suggest the following error message: “Code incorrect: Please, fill in correct code to access the petition or leave blank.” If they put in an incorrect answer twice, they are sent to the end of the questionnaire without further warning (as if having left the box blank).


###  Petition {#behavioral}

The core *behavioral* measure is gathered thus:


<div style="text-align: center; font-weight: bold; margin-top: 20px; margin-bottom: 20px;">
    PETITION
</div>


_____

*The European Parliament is currently discussing and developing policies to address [TREATMENT: Topic] the EU. You are invited to add your voice concerning the following position:*

*The EU needs to [TREATMENT: Policy proposal].*

*Please click one of the options below.*




<div style="border: 1px solid #000; padding: 10px; margin-bottom: 10px;">
    ✓  Add me (anonymously) to this petition and go to the end of the survey
</div>

<div style="border: 1px solid #000; padding: 10px;">
    ✗  Skip this petition and go directly to the end of the survey
</div>

_____



## Outcome Measures 2: Intentions of political behavior {#reported}

Our core *reported* measure of participation is as follows:


*All over Europe, there are debates on how to deal best with [TREATMENT: Topic] the European Union (EU). While there are different opinions, some people propose that the EU needs to [TREATMENT: Policy proposal].*

*Concerning this proposal, there are different actions you can take to make your own opinion in favour or against it visible and heard. How likely would you be to take each of the following two actions?*

< Item order to be randomized.>



```{r echo=FALSE, message=FALSE, warning=FALSE}

# Create a data frame with the likelihood data
likelihood_data <- data.frame(
  Item = c(1, 2),
  Action = c("Contact a politician", "Take part in a public demonstration"),
  `1` = c(1, 1),
  `2` = c(2, 2),
  `3` = c(3, 3),
  `4` = c(4, 4),
  `5` = c(5, 5),
  `6` = c(6, 6),
  Refuse = c(NA, NA),
  DK = c(98, 98)
)

# Create the table using kable and kableExtra
kable(likelihood_data,
      col.names = c("", "Action", "1Not at all likely", "2", "3", "4", "5", "6 Very likely", "Refuse", "DK"), 
      align = c("l", rep("c", 10))) %>%
  kable_styling(full_width = TRUE, position = "center") %>%
  column_spec(9, width = "4em") %>%
  column_spec(10, width = "4em")
```



## Covariates

### Efficacy questions {#efficacy}

*To what extent do you agree or disagree with each of the following statements?*

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Create a data frame with the survey data
survey_data <- data.frame(
  Item = c("6 (external)", "7 (internal)" , "9 (intrinsic)", "10 (opportunity)"),
  Statement = c(
    "Politicians take into consideration the concerns of citizens like me",
    "Sometimes politics seem so complicated that a person like me can't really understand what's  going on.",
    "Participation in politics is important whether or not I have an impact.",
    "Members of the European Parliament are well informed about the political positions of people like me."),
  Fully_agree = c(1, 1, 1, 1),
  Agree = c(2, 2, 2, 2),
  Neither_agree_or_disagree = c(3, 3, 3, 3),
  Disagree = c(4, 4, 4, 4),
  Fully_disagree = c(5, 5, 5, 5),
  DK = c(98, 98, 98, 98)
)

# Create the table using kable and kableExtra
kable(survey_data, col.names = c("", "Statement", "Fully agree", "Agree", "Neither agree or disagree", "Disagree", "Fully disagree", "DK")) %>%
  kable_styling(full_width = TRUE, position = "center") %>%
  add_header_above(c("Q13  To what extent do you agree or disagree with each of the following statements?" = 8)) %>%
  add_header_above(c(" " = 1, "<Items to be randomized>" = 1, "<Source: EES 2019 for items 1 and 2, all other are new items>" = 6)) %>%
  column_spec(1 , width = "15em") |> # Adjust the width of the second column
  column_spec(2, width = "100em") # Adjust the width of the second column
```


In addition we have access to positional questions on two issues:

### Q12 on immigration and climate change

Q12 Now I would like you to tell me your views on various issues. For each issue, we will present you 
with two opposite statements and we will ask your opinion about these two statements. We would like 
to ask you to position yourself on a scale from 0 to 10, where '0' means that you "fully agree with the 
statement at the top" and '10' means that you "fully agree with the statement at the bottom". Then if 
your views are somewhere in between, you can choose any number that describes your position best.
<Source: EES 2019>

### Q12.4 Immigration:  {#MIGVAL}

MIGVAL: 

* 0 fully in favour of a restrictive policy on immigration
* 10 fully opposed to a restrictive policy on immigration
* 98 dk





### Q12.5 Climate Change {#CLIVAL}

CLIVAL: 

* 0 Limiting climate change should take priority even at the cost of economic growth
* 10 Economic growth should take priority even at the cost of accelerating climate 
change
* 98 dk



### Predictors {#controls}

Additional ESS Predictors capturing political orientation:

* DEMSAT: Q2 On the whole, how satisfied are you with the way democracy works in [country]? Are you
* EPARTY: Q6 Which party did you vote for in the European Parliament elections? [*Recoded to a binary variable for antisystem party*.]
* LRPOSN: Q10 In political matters people talk of "the left" and "the right". What is your position? 

Additional ESS measures for:

* Age
* Gender
* Migration background
* SES


# Funding

Funding for  data collection comes from the Cluster of Excellence “Contestations of the Liberal Script” (funded by the DFG); overall funding for the European Election Study 2024 – our project constitutes one module included in the EES questionnaire – comes from a consortium (including SCRIPTS).


# Design declaration

Illustrative design (excluding `stan` estimation).

```{r, eval = TRUE}

# there are both different positions in each country and different effects of position
# xc is a country level feature
po <- function(alignment, external, intrinsic, topic, left, position, xc, uc, xi, ui)
  1 * (((uc + alignment*(.1+xi*external)) * position * (1 + .2 * topic + .3 * left) + ui  + uc + xi + xc) > 3)

design <-
  declare_model(
    country = add_level(N = 27, xc = rnorm(N), uc = runif(N)),
    subject = add_level(
      N = 2000,
      xi = runif(N),
      ui = rnorm(N),
      alignment = pnorm(uc + rnorm(N)),
      external = pnorm(-uc + rnorm(N)),
      intrinsic = pnorm(rnorm(N)),
      position = pnorm(uc + rnorm(N))
    )
  ) +
  declare_assignment(topic = block_ra(blocks = country),
                     left = block_ra(blocks = paste(country, topic))) +
  declare_inquiry(
    ate_external = mean(
      po(alignment, 1, intrinsic, topic, left, position, xc, uc, xi, ui) -
        po(alignment, 0, intrinsic, topic, left, position, xc, uc, xi, ui)
    ),
    ate_topic = mean(
      po(alignment, external, intrinsic, 1, left, position, xc, uc, xi, ui) -
        po(alignment, external, intrinsic, 0, left, position, xc, uc, xi, ui)
    ),
    ate_left = mean(
      po(alignment, external, intrinsic, topic, 1, position, xc, uc, xi, ui) -
        po(alignment, external, intrinsic, topic, 0, position, xc, uc, xi, ui)
    )
  ) +
  declare_measurement(
    Y = po(alignment, external, intrinsic, topic, left, position, xc, uc, xi, ui),
    X_1 = alignment - mean(alignment),
    X_2  = external - mean(external),
    X_3  = intrinsic - mean(intrinsic)
  ) +
  declare_estimator(
    Y ~ X_1 * X_2 * X_3 + topic + left,
    cluster = country,
    fixed_effects = ~ country,
    se_type = "stata",
    term = c("X_2", "topic", "left"),
    inquiry = c("ate_external", "ate_topic", "ate_left")
  )

if(run){
  set.seed(1)
  draw_data(design) |> write_rds("data.rds")
  }

data <- read_rds("data.rds")

get_estimates(design, data) |> kable(digits = 2)

```

```{r}
country_df <- 
  data |> group_by(country) |> summarize(mean_y = mean(Y), mean_xc = mean(xc))

country_df |> ggplot(aes(mean_xc, mean_y, label = country)) + geom_text()

```

Illustrative diagnosis only for lm estimators

```{r}
if(run)
  diagnose_design(design, sims = 50) |> write_rds("diagnosis.rds")

read_rds("diagnosis.rds") |> reshape_diagnosis() |> kable()
```

## Hierarchical model illustrations: Paper 1

### Analysis 1.1: Primary
Sample estimation:

```{r}
# Fit the logistic mixed-effects model
if(run)
  rstanarm::stan_glmer(Y ~ 1 + (1 | country), data = data, family = binomial(link = "logit")) |>
  write_rds("M_1.1.rds")

M_1.1 <-  read_rds("M_1.1.rds")
```

Sample display:

```{r}
# Extract the posterior samples of the random effects
posterior_samples <- as.data.frame(M_1.1)

# Get the unique country names
countries <- unique(data$country)

# Function to calculate predicted probabilities for each country
get_predicted_probs <- function(country, fit, posterior_samples) {
  # Extract the random intercepts for the country
  random_intercept <- posterior_samples[, grep(paste0("b\\[\\(Intercept\\) country:", country, "\\]"), colnames(posterior_samples))]
  # Calculate the log-odds for each posterior sample
  log_odds <- posterior_samples$`(Intercept)` + random_intercept
  # Convert log-odds to probabilities
  probs <- exp(log_odds) / (1 + exp(log_odds))
  return(probs)
}

# Create a dataframe to store the results
results <- data.frame(
  country = rep(countries, each = nrow(posterior_samples)),
  probs = unlist(lapply(countries, get_predicted_probs, fit, posterior_samples))
)

# Summarize the predicted probabilities
summary_results <- results %>%
  group_by(country) %>%
  summarize(
    expectation = mean(probs),
    min_prob = min(probs),
    max_prob = max(probs)
  )

# Plot the results
ggplot(summary_results, aes(x = country, y = expectation)) +
  geom_point() +
  geom_errorbar(aes(ymin = min_prob, ymax = max_prob)) +
  labs(title = "Predicted Probabilities by Country",
       y = "Predicted Probability",
       x = "Country") +
  theme_minimal()


```

### Analysis 1.2: Secondary. Implemented separately by topic.

```{r}
if(run)
  rstanarm::stan_glmer(Y ~ 1 + position + (1 + position | country), 
                      family = binomial(link = "logit"), 
                      data = data |> filter(topic ==1 & left ==1)) |>
  write_rds("M_1.2.rds")

M_1.2 <-  read_rds("M_1.2.rds")

# summary(object = M_1.2)

posterior_1.2 <- data.frame(extract(M_1.2$stanfit))

posterior_1.2 |> apply(2, mean)

posterior_1.2$theta_L.1 |> hist()
posterior_1.2$theta_L.2 |> hist()
posterior_1.2$theta_L.3 |> hist()

data$prediction_1.2[data$topic ==1 & data$left ==1] <- 
  posterior_predict(M_1.2) |> apply(2, mean)


data$counterfactual_1.2[data$topic ==1 & data$left ==1] <- 
  posterior_predict(M_1.2,
                    new_data = data |>
                      mutate(position = mean(position))) |> apply(2, mean)

df <- data |> select(country, Y, prediction_1.2, counterfactual_1.2) |> 
  group_by(country) |> summarize_all(mean, na.rm = TRUE)

  df |> ggplot(aes(prediction_1.2, Y)) + geom_point()

  df |> ggplot(aes(prediction_1.2, counterfactual_1.2)) + geom_point()
```


### Analysis 1.3: Tertiary. Implemented on supporters subset.

```{r}

# reference: https://jrnold.github.io/bayesian_notes/multilevel-models.html#with-group-level-covariates

# xc is a country level feature
if(run)
  rstanarm::stan_glmer(Y ~  (1 | country) + xc, 
                       family = binomial(link = "logit"),
                      data = data |> filter(position > .5)) |>
  write_rds("M_1.3.rds")

M_1.3 <-  read_rds("M_1.3.rds")

posterior_1.3 <- data.frame(extract(M_1.3$stanfit))

posterior_1.3 |> apply(2, mean)

posterior_1.3$theta_L |> hist()

# data |> group_by(country) |> summarize(mean(xc)) |> 
#   mutate(k = (posterior_1.3 |> apply(2, mean))[2:29])
```


## Estimation illustrations: Paper 2

### 2.1

Estimation is as in the design declaration above with a full set of efficacy terms but conditional on supportive subjects for the behavioral measure.

Of particular interest is the relative importance of intrinsic and instrumental aspects and whether these complement or substitute for each other. 


### 2.2


```{r}
if(run)
  rstanarm::stan_glmer(Y ~ 1 + topic*left + alignment + external + intrinsic  + (1 + alignment + external + intrinsic | country), 
                      family = binomial(link = "logit"), 
                      data = data) |>
  write_rds("M_2.2.rds")

# M_2.2 <-  read_rds("M_2.2.rds")

```

### 2.3

Individual covariates examined one at a time.

```{r}
M_2.3 <- 
  lm_robust(
    Y ~ xi*alignment*external*intrinsic + topic*left,
    cluster = country,
    fixed_effects = ~ country,
    se_type = "stata",
    data = data
  )

# check that change of data changes interactions terms in prediction
base_prediction <- predict(M_2.3, newdata = data)
alignment_prediction <- predict(M_2.3, newdata = data |> mutate(alignment = mean(alignment)))

plot(data$xi, base_prediction - alignment_prediction)
```

# References

